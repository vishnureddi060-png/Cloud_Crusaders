<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atmospheric Analysis Console</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        /* --- FONT & ROOT VARIABLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@400;500&display=swap');

        :root {
            --bg-primary: #020a17;
            --bg-secondary: #081424;
            --ui-border-color: #00d9ff;
            --glow-color: #00d9ff;
            --accent-color: #9effff;
            --text-primary: #e0e5ff;
            --text-secondary: #00d9ff;
            --font-display: 'Orbitron', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        /* --- BASE & LAYOUT --- */
        * { box-sizing: border-box; }
        html, body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-mono);
            margin: 0;
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-image: radial-gradient(rgba(0, 217, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .hidden { display: none !important; }

        /* --- MAIN SECTIONS --- */
        .control-panel {
            width: 380px;
            flex-shrink: 0;
            background-color: rgba(8, 20, 36, 0.8);
            backdrop-filter: blur(10px);
            border-right: 2px solid rgba(0, 217, 255, 0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 5px 0 25px rgba(0, 217, 255, 0.1);
            z-index: 10;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- ALIEN UI COMPONENTS --- */
        .ui-panel {
            background: linear-gradient(145deg, rgba(8, 20, 36, 0.6), rgba(12, 28, 48, 0.6));
            border: 1px solid rgba(0, 217, 255, 0.2);
            position: relative;
            clip-path: polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
        }
        
        .panel-header {
            padding: 10px 15px;
            font-family: var(--font-display);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 1rem;
            letter-spacing: 3px;
            color: var(--accent-color);
            background: rgba(0, 217, 255, 0.1);
            text-shadow: 0 0 8px var(--glow-color);
        }

        .panel-content { padding: 15px; }

        /* --- CONTROL PANEL SPECIFICS --- */
        #run-analysis-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, var(--glow-color), #00a5c7);
            color: var(--bg-primary);
            font-weight: 900;
            border: none;
            font-family: var(--font-display);
            font-size: 1rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5), inset 0 0 5px rgba(255,255,255,0.4);
            clip-path: polygon(0 5px, 5px 0, calc(100% - 5px) 0, 100% 5px, 100% calc(100% - 5px), calc(100% - 5px) 100%, 5px 100%, 0 calc(100% - 5px));
        }
        #run-analysis-btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.8), inset 0 0 8px rgba(255,255,255,0.5);
        }
        #run-analysis-btn:disabled {
            background: #2a3158;
            cursor: not-allowed;
            color: #6a7199;
            box-shadow: none;
        }

        #selected-location-name {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.2rem;
            text-shadow: 0 0 5px var(--glow-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #alerts-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- MAP & DASHBOARD --- */
        #map {
            height: 100%;
            width: 100%;
        }
        .dashboard {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 340px;
            z-index: 1000;
            background: rgba(8, 20, 36, 0.8);
            backdrop-filter: blur(10px);
        }

        #dashboard-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        #placeholder-text-container {
            color: var(--text-secondary);
            font-size: 1.2rem;
            letter-spacing: 1px;
            text-align: center;
            text-shadow: 0 0 5px var(--glow-color);
        }

        #results-container { display: flex; gap: 20px; height: 100%; padding: 20px; }
        .chart-container { flex-grow: 1; position: relative; }
        #metrics-container {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            width: 250px;
        }

        /* --- CUSTOM LOADER --- */
        #loader-container .loader {
            width: 80px;
            height: 80px;
            border: 2px solid transparent;
            border-radius: 50%;
            position: relative;
            animation: rotate 4s linear infinite;
        }
        .loader::before, .loader::after {
            content: '';
            position: absolute;
            inset: 4px;
            border: 2px solid transparent;
            border-radius: 50%;
        }
        .loader::before {
            border-top-color: var(--glow-color);
            border-bottom-color: var(--glow-color);
            animation: rotate 2s linear infinite;
        }
        .loader::after {
            border-left-color: var(--accent-color);
            border-right-color: var(--accent-color);
            animation: rotate 3s linear infinite reverse;
        }
        @keyframes rotate { 100% { transform: rotate(360deg) } }

        /* --- LEAFLET CUSTOMIZATION --- */
        .leaflet-control-geocoder { border-radius: 0; }
        .leaflet-control-geocoder-form input {
            background-color: var(--bg-secondary);
            border: 1px solid var(--ui-border-color);
            color: var(--text-primary);
            font-family: var(--font-mono);
            padding: 8px 12px;
            border-radius: 0;
            transition: all 0.2s ease;
        }
        .leaflet-control-geocoder-form input:focus {
            box-shadow: 0 0 10px var(--glow-color);
        }
        
        /* Responsive adjustments */
        @media (max-width: 900px) {
            body { flex-direction: column; }
            .control-panel { width: 100%; height: auto; border-right: none; border-bottom: 2px solid rgba(0, 217, 255, 0.3); }
            .dashboard { height: auto; position: relative; bottom: 0; left: 0; right: 0; border: none; }
            #results-container { flex-direction: column; }
            #metrics-container { width: 100%; grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Left Side: Control Panel -->
    <aside class="control-panel">
        <div class="ui-panel">
            <div class="panel-header">SYSTEM CONTROL</div>
            <div class="panel-content">
                <button id="run-analysis-btn">
                    <span id="btn-text">INITIATE ANALYSIS</span>
                </button>
            </div>
        </div>
        <div class="ui-panel" style="flex-shrink: 0;">
             <div class="panel-header">SELECTED TARGET</div>
            <div class="panel-content">
                <p id="selected-location-name" class="font-mono">Visakhapatnam</p>
            </div>
        </div>
        <div class="ui-panel" style="flex-grow: 1; display: flex; flex-direction: column; min-height: 150px;">
            <div class="panel-header">THREAT ALERTS</div>
            <div class="panel-content" id="alerts-container">
                <div class="text-text-secondary">Awaiting system analysis...</div>
            </div>
        </div>
    </aside>

    <!-- Right Side: Map and Dashboard -->
    <main class="main-content">
        <div id="map"></div>
        <div id="dashboard" class="dashboard ui-panel">
            <div class="panel-header" id="dashboard-title">AWAITING DATA STREAM</div>

            <!-- Placeholder shown before analysis -->
            <div id="dashboard-placeholder" class="w-full h-full flex items-center justify-center flex-col p-4">
                <div id="loader-container" class="hidden text-center">
                    <div class="loader" style="margin: 0 auto 20px auto;"></div>
                    <p id="loader-text" class="font-mono text-accent-color tracking-widest">ESTABLISHING SYSTEM LINK...</p>
                </div>
                 <div id="placeholder-text-container">
                    <p>Select target coordinates.</p>
                    <p>Engage analysis protocol.</p>
                </div>
            </div>

            <!-- Results shown after analysis -->
            <div id="results-container" class="hidden">
                <div class="chart-container">
                    <canvas id="prediction-chart"></canvas>
                </div>
                <div id="metrics-container">
                    <!-- Metrics will be injected here by JS -->
                </div>
            </div>
        </div>
    </main>

<script>
    // --- STATE & ELEMENTS ---
    let selectedRegion = { lat: 17.6868, lng: 83.2185, zoom: 9, name: "Visakhapatnam" };
    let predictionChart = null;
    let mapMarker = null; // Main marker reference

    const analysisBtn = document.getElementById('run-analysis-btn');
    const btnText = document.getElementById('btn-text');
    const alertsContainer = document.getElementById('alerts-container');
    const dashboardPlaceholder = document.getElementById('dashboard-placeholder');
    const loaderContainer = document.getElementById('loader-container');
    const loaderText = document.getElementById('loader-text');
    const placeholderTextContainer = document.getElementById('placeholder-text-container');
    const resultsContainer = document.getElementById('results-container');
    const chartCanvas = document.getElementById('prediction-chart').getContext('2d');
    const metricsContainer = document.getElementById('metrics-container');
    const locationNameEl = document.getElementById('selected-location-name');
    const dashboardTitleEl = document.getElementById('dashboard-title');

    // --- MAP INITIALIZATION ---
    // Switched to a high-contrast, futuristic map theme
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([selectedRegion.lat, selectedRegion.lng], selectedRegion.zoom);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
	    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);
     L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
	    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20,
        pane: 'shadowPane' 
    }).addTo(map);


    const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: 'Search Target Location...',
        collapsed: false,
        errorMessage: 'Target location not found.'
    }).on('markgeocode', function(e) {
        const { center, name } = e.geocode;
        if (e.geocode.marker) map.removeLayer(e.geocode.marker);
        if (mapMarker) { mapMarker.setLatLng(center); } 
        else { mapMarker = L.marker(center).addTo(map); }
        selectedRegion = { lat: center.lat, lng: center.lng, name: name.split(',')[0] };
        locationNameEl.textContent = selectedRegion.name;
        map.setView(center, 10);
    }).addTo(map);
    
    // Custom Marker
    const alienIcon = L.divIcon({
        className: 'custom-div-icon',
        html: `<div style='background-color: var(--glow-color); width: 1rem; height: 1rem; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px var(--glow-color);'></div>`,
        iconSize: [22, 22],
        iconAnchor: [11, 11]
    });
    mapMarker = L.marker([selectedRegion.lat, selectedRegion.lng], { icon: alienIcon }).addTo(map);

    // --- CLICK HANDLER ---
    map.on('click', function(e) {
        const center = e.latlng;
        mapMarker.setLatLng(center);
        map.panTo(center);
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`)
            .then(res => res.json())
            .then(data => {
                const name = data.display_name ? data.display_name.split(',')[0] : `COORD: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
                selectedRegion = { lat: center.lat, lng: center.lng, name };
                locationNameEl.textContent = name;
            })
            .catch(err => {
                const fallbackName = `COORD: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
                selectedRegion = { lat: center.lat, lng: center.lng, name: fallbackName };
                locationNameEl.textContent = fallbackName;
            });
    });

    // --- SIMULATED BACKEND & UI FUNCTIONS ---
    async function runCloudAnalysis(location) {
        const buildResponse = (statusCode, body) => ({ statusCode, body });
        const getMockEarthObservationData = (loc) => Array.from({ length: 10 }).map((_, i) => ({
            ts: new Date(Date.now() - (9 - i) * 24 * 3600 * 1000).toISOString().slice(0, 10),
            aod: +(0.1 + Math.random() * 0.7).toFixed(2),
            no2: +(15 + Math.random() * 40).toFixed(1)
        }));
        const runPredictionModel = (eoData) => eoData.map(row => ({
            date: row.ts,
            predicted_pm25: Math.max(0, +((row.aod * 50) + (row.no2 * 0.5) + (Math.random() - 0.5) * 10).toFixed(1))
        }));
        const eoData = getMockEarthObservationData(location);
        const predictions = runPredictionModel(eoData);
        const alerts = predictions.filter(p => p.predicted_pm25 > 55).map(p => ({
            date: p.date,
            level: p.predicted_pm25 > 90 ? "CRITICAL Anomaly" : "ELEVATED Reading",
            value: p.predicted_pm25
        }));
        return buildResponse(200, { predictions, alerts });
    }

    function setLoadingState(isLoading) {
        analysisBtn.disabled = isLoading;
        btnText.textContent = isLoading ? 'ANALYZING...' : 'INITIATE ANALYSIS';
        placeholderTextContainer.classList.toggle('hidden', isLoading);
        loaderContainer.classList.toggle('hidden', !isLoading);
    }

    function displayAlerts(alerts, error = null) {
        alertsContainer.innerHTML = '';
        if (error) {
            alertsContainer.innerHTML = `<div class="p-3 rounded-lg bg-red-900 bg-opacity-50 border border-red-500 text-red-300 text-sm font-semibold">${error}</div>`;
            return;
        }
        if (alerts.length === 0) {
            alertsContainer.innerHTML = `<div class="p-3 bg-green-900 bg-opacity-30 border border-green-500 text-green-300 text-sm font-semibold">ATMOSPHERE NOMINAL. No threats detected.</div>`;
            return;
        }
        alerts.forEach(alert => {
            const isCritical = alert.level.includes("CRITICAL");
            const alertEl = document.createElement('div');
            alertEl.className = `p-3 border-l-4 ${isCritical ? 'bg-red-900 bg-opacity-50 border-red-500' : 'bg-yellow-900 bg-opacity-50 border-yellow-500'}`;
            alertEl.innerHTML = `
                <div class="font-bold text-sm tracking-wider ${isCritical ? 'text-red-300' : 'text-yellow-300'}">${alert.level}</div>
                <div class="text-xs text-text-secondary">${alert.date} // PM2.5: ${alert.value} µg/m³</div>
            `;
            alertsContainer.appendChild(alertEl);
        });
    }

    function displayMetrics(predictions) {
        const values = predictions.map(p => p.predicted_pm25);
        const peakPM = Math.max(...values).toFixed(1);
        const avgPM = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
        const unhealthyDays = values.filter(v => v > 55).length;
        metricsContainer.innerHTML = `
            <div class="ui-panel p-4 text-center"><p class="text-sm text-text-secondary tracking-widest">PEAK PM2.5</p><p class="text-3xl font-bold text-accent-color font-mono">${peakPM}</p></div>
            <div class="ui-panel p-4 text-center"><p class="text-sm text-text-secondary tracking-widest">10-DAY AVG</p><p class="text-3xl font-bold text-accent-color font-mono">${avgPM}</p></div>
            <div class="ui-panel p-4 text-center"><p class="text-sm text-text-secondary tracking-widest">ANOMALY DAYS</p><p class="text-3xl font-bold text-accent-color font-mono">${unhealthyDays}</p></div>
        `;
    }

    function displayChart(predictions) {
        const labels = predictions.map(p => p.date);
        const data = predictions.map(p => p.predicted_pm25);
        if (predictionChart) predictionChart.destroy();
        
        const gradient = chartCanvas.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(0, 217, 255, 0.5)');
        gradient.addColorStop(1, 'rgba(0, 217, 255, 0)');

        predictionChart = new Chart(chartCanvas, {
            type: 'line',
            data: { labels, datasets: [{
                label: 'Predicted PM2.5 (µg/m³)', data,
                borderColor: 'var(--glow-color)', backgroundColor: gradient,
                borderWidth: 2, fill: true, tension: 0.4, 
                pointBackgroundColor: 'var(--accent-color)', pointRadius: 0, pointHoverRadius: 6,
                pointHoverBorderColor: 'white', pointHoverBorderWidth: 2,
            }]},
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0, 217, 255, 0.1)' }, ticks: { color: 'var(--text-secondary)' } },
                    x: { grid: { color: 'rgba(0, 217, 255, 0.1)' }, ticks: { color: 'var(--text-secondary)' } }
                }
            }
        });
    }

    // --- ANALYSIS BUTTON ---
    analysisBtn.addEventListener('click', async () => {
        setLoadingState(true);
        dashboardPlaceholder.classList.remove('hidden');
        resultsContainer.classList.add('hidden');
        await new Promise(res => setTimeout(res, 750));
        loaderText.textContent = "RECEIVING DATA STREAM...";
        const response = await runCloudAnalysis(selectedRegion);
        await new Promise(res => setTimeout(res, 750));
        if (response.statusCode === 200) {
            const { predictions, alerts } = response.body;
            dashboardTitleEl.textContent = `DATA STREAM // ${selectedRegion.name.toUpperCase()}`;
            displayChart(predictions);
            displayMetrics(predictions);
            displayAlerts(alerts);
            dashboardPlaceholder.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
        } else {
            displayAlerts([], "UPLINK FAILED. Check connection and retry.");
            placeholderTextContainer.classList.remove('hidden');
            loaderContainer.classList.add('hidden');
        }
        setLoadingState(false);
        loaderText.textContent = "ESTABLISHING SYSTEM LINK...";
    });
</script>

</body>
</html>
